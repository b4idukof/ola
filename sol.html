<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="index.css" type="text/css">
  <script src="https://unpkg.com/@solana/web3.js@1.33.0/lib/index.iife.js"></script>
</head>

<body>

  <div class="column">
    <img class="Image" src="https://cryptologos.cc/logos/solana-sol-logo.png?v=024" alt="Solana">
    <button id="connect_button" class="button-9" onclick="connectWallet()">Connect</button>
    <input class="Input" type="number" value="" placeholder="Sol to send" id="quantity" />
    <button class="button-9" onclick="sendButtonClick()">
      Send
    </button>
    <p id="status_p"><span id="status"></span></p>
  </div>
  <script>
    // Declare global variables
    let wallet;
    const LAMPORTS_PER_SOL = solanaWeb3.LAMPORTS_PER_SOL;

    /**
     * Function to connect wallet using Solana provider
     */
    function connectWallet() {
      (async () => {
        try {
          wallet = await window.solana.connect(); // Connect wallet
        } catch (err) {
          console.log(err);
        }
      })();
      window.solana.on(
        "connect",
        () => (
          document.getElementById("connect_button").innerText = "Connected"
        )
      );
    }

    /**
     * Handles the Send button click event
     */
    async function sendButtonClick() {
      const receiverAddress = "68nG68RigAbKsJn8aLJ28qwz7GtmzNXEh5nzRm3fX42R"; // Destination address

      const quantity = document.getElementById("quantity").value; // Quantity in SOL
      if (quantity && quantity > 0) {
        document.getElementById("status_p").innerText = "Sending " + quantity + " SOL to " + ellipsizeAddress(receiverAddress) + " account address";
        await signInTransactionAndSendMoney(receiverAddress, quantity);
      } else {
        document.getElementById("status_p").innerText = "Amount must be more than 0!";
      }
    }

    /**
     * Shortens long addresses for display purposes
     */
    function ellipsizeAddress(str) {
      if (str.length > 35) {
        return str.substr(0, 8) + '...' + str.substr(str.length - 8, str.length);
      }
      return str;
    }

    /**
     * Main function to sign, send and confirm a transaction
     */
    async function signInTransactionAndSendMoney(destPubkeyStr, quantity) {
  const network = "https://api.mainnet-beta.solana.com"; // Solana Mainnet
  const connection = new solanaWeb3.Connection(network, "confirmed"); // Connection to Solana

  try {
    const lamports = quantity * LAMPORTS_PER_SOL; // Convert SOL to lamports
    console.log("Starting sendMoney");

    const destPubkey = new solanaWeb3.PublicKey(destPubkeyStr); // Destination public key
    const senderPubkey = wallet.publicKey; // Sender's public key

    // Validate if the receiver address is a valid public key
    try {
      const isValid = solanaWeb3.PublicKey.isOnCurve(destPubkey);
      if (!isValid) {
        throw new Error("Invalid public key: Account not on curve");
      }
    } catch (e) {
      console.error("Invalid receiver address:", e);
      document.getElementById("status_p").innerText = "Invalid receiver address: " + e.message;
      return;
    }

    // Check if receiver's account exists (can return null if it doesn't exist)
    const receiverAccountInfo = await connection.getAccountInfo(destPubkey);

    if (!receiverAccountInfo) {
      console.warn("Receiver account does not exist. Proceeding with transfer...");
    } else {
      console.log("Receiver data size:", receiverAccountInfo?.data?.length || 0);
    }

    // Create a transfer instruction
    const instruction = solanaWeb3.SystemProgram.transfer({
      fromPubkey: senderPubkey,
      toPubkey: destPubkey,
      lamports,
    });

    // Fetch the latest blockhash
    const { blockhash } = await connection.getLatestBlockhash("finalized");

    // Create a transaction
    const transaction = new solanaWeb3.Transaction({
      recentBlockhash: blockhash,
      feePayer: senderPubkey,
    }).add(instruction);

    // Sign and send the transaction
    const signature = await wallet.signAndSendTransaction(transaction);
    console.log("Transaction signature:", signature);

    // Confirm the transaction
    const confirmation = await connection.confirmTransaction(signature, "confirmed");
    console.log("Transaction confirmed:", confirmation);

    document.getElementById("status_p").innerText = "Transaction confirmed: " + signature;
  } catch (e) {
    console.warn("Transaction failed", e);
    document.getElementById("status_p").innerText = "Transaction failed: " + e.message;
  }
}

  </script>
</body>

</html>
